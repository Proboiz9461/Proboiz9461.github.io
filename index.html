<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Realtime Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<link rel="stylesheet" href="style.css">
</head>
<body data-theme="dark">

<div id="login">
  <h2>Join Chat</h2>
  <input id="username" placeholder="Username">
  <input id="room" placeholder="Room name">
  <button onclick="join()">Join</button>
</div>

<div id="chat" class="hidden">

<header>
  <span id="roomName"></span>
  <button onclick="toggleTheme()">ðŸŒ“</button>
</header>

<div id="users"></div>

<div id="messages"></div>
<div id="typing"></div>

<div class="input">
  <input id="msg" placeholder="Message">
  <button onclick="send()">Send</button>
</div>

</div>

<script>
var firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
let user="", room="", userRef, typingRef;

function join(){
  user = username.value.trim();
  room = room.value.trim();
  if(!user || !room) return;

  login.style.display="none";
  chat.classList.remove("hidden");
  roomName.innerText = "Room: " + room;

  userRef = db.ref(`rooms/${room}/users/${user}`);
  userRef.set(true);
  userRef.onDisconnect().remove();

  typingRef = db.ref(`rooms/${room}/typing/${user}`);

  listen();
}

function send(){
  if(!msg.value.trim()) return;
  db.ref(`rooms/${room}/messages`).push({
    user, text: msg.value, time: Date.now()
  });
  msg.value="";
  typingRef.remove();
}

msg.oninput = () => typingRef.set(true);

function listen(){
  db.ref(`rooms/${room}/messages`).limitToLast(100)
  .on("child_added", snap=>{
    const m=snap.val();
    const div=document.createElement("div");
    div.className = "bubble " + (m.user===user?"me":"other");
    div.innerHTML = `<b>${m.user}</b><br>${m.text}`;
    div.onclick = ()=> {
      if(m.user===user) snap.ref.remove();
    };
    messages.appendChild(div);
    messages.scrollTop=99999;
  });

  db.ref(`rooms/${room}/users`).on("value", snap=>{
    users.innerText = "Online: " + Object.keys(snap.val()||{}).join(", ");
  });

  db.ref(`rooms/${room}/typing`).on("value", snap=>{
    const list=Object.keys(snap.val()||{}).filter(u=>u!==user);
    typing.innerText = list.length? list.join(", ")+" typing...":"";
  });
}

function toggleTheme(){
  document.body.dataset.theme =
    document.body.dataset.theme==="dark"?"light":"dark";
}
</script>
</body>
</html>
