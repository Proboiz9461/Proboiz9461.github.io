const modeScreen = document.getElementById("modeScreen");
const game = document.getElementById("game");
const puzzle = document.getElementById("puzzle");
const movesEl = document.getElementById("moves");

let tiles = [1,2,3,4,5,6,7,8,null];
let moves = 0;

// MODE
function startNormal() {
    modeScreen.style.display = "none";
    game.style.display = "block";
    init();
}

function startAdmin() {
    const pwd = prompt("Enter admin password:");
    if (pwd === "67") startNormal();
    else alert("Wrong password");
}

// INIT
function init() {
    moves = 0;
    movesEl.textContent = "Moves: 0";
    draw();
}

// DRAW
function draw() {
    puzzle.innerHTML = "";

    tiles.forEach((v, i) => {
        const d = document.createElement("div");

        if (v === null) {
            d.className = "tile empty";
        } else {
            d.className = "tile";
            d.style.backgroundPosition =
                `${-((v-1)%3)*100}px ${-Math.floor((v-1)/3)*100}px`;
            d.onclick = () => move(i);
        }

        puzzle.appendChild(d);
    });

    if (isSolved()) winEffect();
}

// MOVE
function move(i) {
    const e = tiles.indexOf(null);
    const r = Math.floor(i/3), c = i%3;
    const er = Math.floor(e/3), ec = e%3;

    if ((r===er && Math.abs(c-ec)===1) ||
        (c===ec && Math.abs(r-er)===1)) {

        [tiles[i], tiles[e]] = [tiles[e], tiles[i]];
        moves++;
        movesEl.textContent = "Moves: " + moves;
        draw();
    }
}

// SHUFFLE
function shuffle() {
    for (let i=0;i<150;i++) {
        moveRandom();
    }
    moves = 0;
    movesEl.textContent = "Moves: 0";
    draw();
}

function moveRandom() {
    const e = tiles.indexOf(null);
    const opts = [];
    const r = Math.floor(e/3), c = e%3;
    if (r>0) opts.push(e-3);
    if (r<2) opts.push(e+3);
    if (c>0) opts.push(e-1);
    if (c<2) opts.push(e+1);
    const m = opts[Math.floor(Math.random()*opts.length)];
    [tiles[e], tiles[m]] = [tiles[m], tiles[e]];
}

// SOLVED CHECK
function isSolved() {
    for (let i=0;i<8;i++) if (tiles[i]!==i+1) return false;
    return tiles[8]===null;
}

// WIN
function winEffect() {
    puzzle.classList.add("win");
}

// MOBILE SWIPE
let startX, startY;

puzzle.addEventListener("touchstart", e=>{
    const t = e.touches[0];
    startX = t.clientX;
    startY = t.clientY;
});

puzzle.addEventListener("touchend", e=>{
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    const empty = tiles.indexOf(null);

    if (Math.abs(dx)>Math.abs(dy)) {
        if (dx>40) tryMove(empty-1);
        else if (dx<-40) tryMove(empty+1);
    } else {
        if (dy>40) tryMove(empty-3);
        else if (dy<-40) tryMove(empty+3);
    }
});

function tryMove(i) {
    if (i>=0 && i<9) move(i);
}
